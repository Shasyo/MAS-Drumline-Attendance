<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MAS Drumline Attendance</title>
<style>
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
    margin:0;
    background:#f5f5f5;
    display:flex;
    flex-direction:column;
    align-items:center;
  }

  h2 {
    text-align:center;
    margin-bottom:20px;
  }

  .input-group {
    width:100%;
    max-width:400px;
    margin-bottom:15px;
  }

  input, select, button {
    font-size:18px;
    width:100%;
    padding:12px 10px;
    margin-top:5px;
    border-radius:8px;
    border:1px solid #ccc;
    box-sizing:border-box;
  }

  button {
    background:#000;
    color:white;
    border:none;
    cursor:pointer;
    margin-top:10px;
    transition: background 0.2s;
  }

  button:active {
    background:#333;
  }

  #status {
    margin-top:20px;
    font-size:18px;
    text-align:center;
  }

  @media(max-width:480px){
    body{padding:15px;}
    input,select,button{font-size:16px;padding:10px 8px;}
    #status{font-size:16px;}
  }

  /* Loading overlay */
  #loadingOverlay {
    display: none;
    position: fixed;
    top:0; left:0;
    width:100%; height:100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    color: white;
    font-size: 24px;
    font-weight: bold;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  /* Spinner animation */
  .spinner {
    border: 6px solid #f3f3f3;
    border-top: 6px solid #000;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin-bottom: 10px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>
</head>
<body>

<h2>MAS Drumline Attendance</h2>

<div class="input-group"><input id="fullname" placeholder="Full Name" /></div>
<div class="input-group"><input id="idNumber" placeholder="ID#" /></div>
<div class="input-group">
  <select id="team">
    <option value="">Select Team</option>
    <option>Ashbal</option>
    <option>Zahrat</option>
    <option>Morshedat</option>
    <option>Kashafeen</option>
    <option>Morasha7 Gawala</option>
  </select>
</div>

<div class="input-group"><button onclick="checkIn()">Check In</button></div>
<p id="status"></p>

<!-- Loading overlay -->
<div id="loadingOverlay">
  <div class="spinner"></div>
  Processing...
</div>

<script>
const API_URL = "https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec";

// Persistent deviceID
let deviceID = localStorage.getItem("deviceID");
if (!deviceID) { 
  deviceID = crypto.randomUUID(); 
  localStorage.setItem("deviceID", deviceID); 
}

// Show/hide loading with fade
function showLoading(show = true) {
  const overlay = document.getElementById("loadingOverlay");
  if (show) {
    overlay.style.display = "flex";
    setTimeout(()=> overlay.style.opacity = 1, 10); // fade in
  } else {
    overlay.style.opacity = 0;
    setTimeout(()=> overlay.style.display = "none", 300); // fade out after transition
  }
}

function checkIn() {
  const fullName = document.getElementById("fullname").value;
  const idNumber = document.getElementById("idNumber").value;
  const team = document.getElementById("team").value;

  if(!fullName || !team || !idNumber){
    alert("Please fill all fields.");
    return;
  }

  showLoading(true); // show loading

  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;

    fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({ fullName, team, idNumber, deviceID, lat, lng })
    })
    .then(res => res.text())
    .then(msg => {
      showLoading(false); // hide loading

      if(msg==="OK"){ 
        document.getElementById("status").innerHTML="✅ Check-in successful"; 
        // Clear inputs
        document.getElementById("fullname").value="";
        document.getElementById("idNumber").value="";
        document.getElementById("team").value="";
      }
      else if(msg==="ID_EXISTS"){ document.getElementById("status").innerHTML="❌ This ID# already checked in today."; }
      else if(msg==="DEVICE_EXISTS"){ document.getElementById("status").innerHTML="❌ This device already checked in today."; }
      else if(msg==="OUT_OF_RANGE"){ document.getElementById("status").innerHTML="❌ You are not at the event location."; }
      else{ document.getElementById("status").innerHTML="⚠ Something went wrong."; }
    })
    .catch(err => {
      showLoading(false);
      alert("⚠ Network error. Please try again.");
    });

  }, err => {
    showLoading(false);
    alert("⚠ Unable to get location. Make sure location services are enabled.");
  });
}
</script>

</body>
</html>
